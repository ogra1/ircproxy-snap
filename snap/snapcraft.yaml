name: ircproxy
adopt-info: ircproxy
summary: A minimal IRC proxy using bip
description: |
    Run the bip IRC proxy in a snap.
    The snap puts a default configuration in place and generates a fresh ssl key on first startup.
    .
    To configure the service edit the generated config in /var/snap/ircproxy/current/bip.conf
    And restart the service with "sudo snap restart ircproxy"
    .
    To generate an IRC password to use with the config the snap also ships the "ircproxy.bipmkpw" tool.

base: core20
confinement: strict
grade: stable

apps:
  ircproxy:
    command: run-bip
    daemon: simple
    plugs: [network, network-bind]
  bipmkpw:
    command: usr/bin/bipmkpw

layout:
  /etc/ssl:
    bind: $SNAP_DATA/ssl
  /etc/ca-certificates:
    bind: $SNAP/etc/ca-certificates
  /etc/ca-certificates.conf:
    bind-file: $SNAP_DATA/ca-certificates.conf
  /usr/share/ca-certificates:
    bind: $SNAP/usr/share/ca-certificates

parts:
  ircproxy:
    plugin: dump
    source: .
    prime:
      - run-bip
      - config.sh
      - default.yaml
      - etc
      - usr
      - -etc/init.d
      - -etc/default
      - -usr/share/man
      - -usr/share/lintian
      - -lib/systemd/system
      - -usr/share/doc/bip/examples
      - -usr/share/doc/ca-certificates/examples
    override-build: |
      snapcraftctl build
      CHLG="$SNAPCRAFT_PART_INSTALL/usr/share/doc/bip/changelog.Debian.gz"
      VER="$(zgrep -m1 ^bip $CHLG | sed 's/^bip (//;s/).*$//')"
      echo "setting version to $VER"
      snapcraftctl set-version "$VER"
      find $SNAPCRAFT_PART_INSTALL/usr/share/doc -depth -type f,l ! -name copyright|xargs rm
      find $SNAPCRAFT_PART_INSTALL/usr/share/doc -empty|xargs rmdir
    stage-packages:
      - bip
      - ca-certificates
      - libssl1.1
      - openssl
